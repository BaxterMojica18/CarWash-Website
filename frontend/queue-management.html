<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Management - Car Wash</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>Service Queue Management</h1>
        
        <div class="location-selector">
            <label>Select Location:</label>
            <select id="location-select" onchange="loadQueue()">
                <option value="">All Locations</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('queue')">Active Queue</button>
            <button class="tab-btn" onclick="showTab('all')">All Reservations</button>
        </div>

        <div id="queue-tab" class="tab-content active">
            <h2>Current Queue</h2>
            <div id="queue-list"></div>
        </div>

        <div id="all-tab" class="tab-content">
            <h2>All Reservations</h2>
            <div id="all-reservations"></div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/toast.js"></script>
    <script>
        let locations = [];
        let reservations = [];

        async function loadLocations() {
            try {
                locations = await apiRequest('/api/settings/locations', 'GET');
                const select = document.getElementById('location-select');
                select.innerHTML = '<option value="">All Locations</option>' +
                    locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            } catch (error) {
                showToast('Failed to load locations', 'error');
            }
        }

        async function loadQueue() {
            const locationId = document.getElementById('location-select').value;
            
            try {
                if (locationId) {
                    const queue = await apiRequest(`/api/reservations/queue?location_id=${locationId}`, 'GET');
                    renderQueue(queue);
                    
                    reservations = await apiRequest(`/api/reservations?location_id=${locationId}`, 'GET');
                } else {
                    reservations = await apiRequest('/api/reservations', 'GET');
                    const queue = reservations.filter(r => ['pending', 'accepted', 'in_progress'].includes(r.status));
                    renderQueue(queue);
                }
                
                renderAllReservations();
            } catch (error) {
                showToast('Failed to load queue', 'error');
            }
        }

        function renderQueue(queue) {
            const container = document.getElementById('queue-list');
            
            if (queue.length === 0) {
                container.innerHTML = '<p>No active reservations in queue.</p>';
                return;
            }

            container.innerHTML = queue.map(res => `
                <div class="queue-item">
                    <div class="queue-position">#${res.queue_position || '-'}</div>
                    <div class="queue-details">
                        <h3>${res.reservation_number}</h3>
                        <p><strong>${res.service.name}</strong> at ${res.location.name}</p>
                        <p>Vehicle: ${res.vehicle_plate}</p>
                        <p>Status: <span class="status status-${res.status}">${res.status}</span></p>
                        <p>Created: ${new Date(res.created_at).toLocaleString()}</p>
                    </div>
                    <div class="queue-actions">
                        ${res.status === 'pending' ? `
                            <button onclick="updateStatus(${res.id}, 'accepted')" class="btn btn-success">Accept</button>
                            <button onclick="updateStatus(${res.id}, 'cancelled')" class="btn btn-danger">Reject</button>
                        ` : ''}
                        ${res.status === 'accepted' ? `
                            <button onclick="updateStatus(${res.id}, 'in_progress')" class="btn">Start Service</button>
                        ` : ''}
                        ${res.status === 'in_progress' ? `
                            <button onclick="updateStatus(${res.id}, 'completed')" class="btn btn-success">Complete</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderAllReservations() {
            const container = document.getElementById('all-reservations');
            
            if (reservations.length === 0) {
                container.innerHTML = '<p>No reservations found.</p>';
                return;
            }

            container.innerHTML = reservations.map(res => `
                <div class="reservation-card">
                    <div class="card-header">
                        <div>
                            <strong>${res.reservation_number}</strong>
                            ${res.queue_position ? `<span class="queue-badge">#${res.queue_position}</span>` : ''}
                        </div>
                        <span class="status status-${res.status}">${res.status}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>${res.service.name}</strong> at ${res.location.name}</p>
                        <p>Vehicle: ${res.vehicle_plate}</p>
                        <p>Date: ${new Date(res.created_at).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        async function updateStatus(reservationId, status) {
            try {
                await apiRequest(`/api/reservations/${reservationId}/status`, 'PATCH', { status });
                showToast('Reservation status updated', 'success');
                loadQueue();
            } catch (error) {
                showToast('Failed to update status', 'error');
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        loadLocations().then(() => loadQueue());
        setInterval(loadQueue, 30000);
    </script>

    <style>
        .location-selector {
            margin-bottom: 20px;
        }
        .location-selector select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-left: 10px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .queue-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .queue-position {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
            text-align: center;
        }
        .queue-details {
            flex: 1;
        }
        .queue-details h3 {
            margin: 0 0 10px 0;
        }
        .queue-details p {
            margin: 5px 0;
        }
        .queue-actions button {
            margin-right: 10px;
        }
        .reservation-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .card-header {
            background: #f5f5f5;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 15px;
        }
        .card-body p {
            margin: 5px 0;
        }
        .queue-badge {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #d1ecf1; color: #0c5460; }
        .status-in_progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
    </style>
</body>
</html>
